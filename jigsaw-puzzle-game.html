<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>üß© Jigsaw Magic!</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root { --radius: 16px; }
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  body { font-family: 'Nunito', sans-serif; background: linear-gradient(175deg, #fff9f0 0%, #fef3c7 50%, #ecfdf5 100%); min-height: 100vh; overflow-x: hidden; }
  .cloud { position: fixed; font-size: 3rem; opacity: 0.10; animation: driftCloud linear infinite; pointer-events: none; z-index: 0; }
  @keyframes driftCloud { from{transform:translateX(-160px)} to{transform:translateX(calc(100vw + 160px))} }

  header { position:relative;z-index:10;background:linear-gradient(90deg,#06b6d4,#0284c7);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 20px rgba(6,182,212,0.4); }
  .home-btn { background:rgba(255,255,255,0.22);color:white;border:2px solid rgba(255,255,255,0.5);border-radius:50px;padding:7px 14px;font-family:'Nunito',sans-serif;font-weight:900;font-size:0.88rem;cursor:pointer;text-decoration:none;display:inline-block;transition:background 0.2s; }
  .home-btn:active { background:rgba(255,255,255,0.38); }
  header h1 { font-family:'Fredoka One',cursive;font-size:clamp(1.5rem,5vw,2.2rem);color:white;text-shadow:2px 3px 0 rgba(0,0,0,0.15);letter-spacing:1px;flex:1;text-align:center; }
  .hsp { width:70px; }

  .upload-area { position:relative;z-index:10;margin:12px 14px 8px;background:white;border-radius:var(--radius);padding:12px 16px;border:3px dashed #06b6d4;box-shadow:0 4px 16px rgba(6,182,212,0.10); }
  .up-label { font-weight:900;color:#0284c7;font-size:0.92rem;margin-bottom:8px;display:block; }
  .upload-row { display:flex;align-items:center;gap:10px;flex-wrap:wrap; }
  .upload-btn { background:linear-gradient(135deg,#06b6d4,#0284c7);color:white;border:none;border-radius:50px;padding:9px 20px;font-family:'Nunito',sans-serif;font-size:0.9rem;font-weight:900;cursor:pointer;box-shadow:0 4px 12px rgba(6,182,212,0.38);transition:transform 0.15s; }
  .upload-btn:active { transform:scale(0.95); }
  #fileInput { display:none; }
  .up-status { font-size:0.8rem;font-weight:800;color:#059669;margin-top:6px;min-height:16px; }
  .default-picks { display:flex;gap:8px;flex-wrap:wrap;margin-top:8px; }
  .default-pick { width:42px;height:42px;border-radius:10px;font-size:1.5rem;display:flex;align-items:center;justify-content:center;background:#f0fdfa;border:2px solid #99f6e4;cursor:pointer;transition:transform 0.15s,border-color 0.15s; }
  .default-pick.selected { border-color:#06b6d4;background:#cffafe;transform:scale(1.1); }

  .controls-bar { position:relative;z-index:10;display:flex;align-items:center;justify-content:center;gap:10px;padding:6px 14px 10px;flex-wrap:wrap; }
  .diff-btn { border:2.5px solid #06b6d4;background:white;color:#0284c7;border-radius:50px;padding:7px 16px;font-family:'Nunito',sans-serif;font-weight:900;font-size:0.86rem;cursor:pointer;transition:all 0.2s; }
  .diff-btn.active { background:linear-gradient(135deg,#06b6d4,#0284c7);color:white;border-color:transparent;box-shadow:0 4px 12px rgba(6,182,212,0.38); }
  .start-btn { background:linear-gradient(135deg,#f97316,#ef4444);color:white;border:none;border-radius:50px;padding:11px 28px;font-family:'Fredoka One',cursive;font-size:1.05rem;cursor:pointer;box-shadow:0 5px 18px rgba(249,115,22,0.42);transition:transform 0.15s; }
  .start-btn:active { transform:scale(0.95); }
  .start-btn:disabled { opacity:0.45;cursor:not-allowed;transform:none; }

  .stats-row { display:flex;justify-content:center;gap:12px;flex-wrap:wrap;position:relative;z-index:10;padding:0 14px 8px; }
  .stat { background:white;border-radius:50px;padding:6px 16px;font-weight:900;font-size:0.9rem;color:#0284c7;box-shadow:0 3px 10px rgba(6,182,212,0.18);border:2px solid #a5f3fc; }

  .game-wrapper { position:relative;z-index:10;display:flex;flex-direction:column;align-items:center;gap:14px;padding:0 12px 24px; }
  .preview-box { background:white;border-radius:var(--radius);padding:10px;box-shadow:0 4px 16px rgba(0,0,0,0.10);border:3px solid #fbbf24;display:none;flex-direction:column;align-items:center;gap:6px; }
  .preview-label { font-family:'Fredoka One',cursive;color:#f97316;font-size:0.92rem; }
  .preview-img { width:100px;height:100px;object-fit:cover;border-radius:10px;display:block; }

  .puzzle-section { width:100%;max-width:480px;background:white;border-radius:var(--radius);padding:12px;box-shadow:0 6px 24px rgba(0,0,0,0.10);border:3px solid #a5f3fc; }
  .puzzle-label { font-family:'Fredoka One',cursive;color:#0284c7;font-size:0.95rem;text-align:center;margin-bottom:8px; }
  #puzzleBoard { position:relative;margin:0 auto;background:repeating-conic-gradient(#e0f7fa 0% 25%,#f0fdfe 0% 50%) 0 0/20px 20px;border-radius:10px;touch-action:none; }

  .tray-section { width:100%;max-width:480px;background:linear-gradient(135deg,#fff7ed,#fffbeb);border-radius:var(--radius);padding:14px 12px;box-shadow:0 6px 24px rgba(0,0,0,0.07);border:3px solid #fed7aa;min-height:120px; }
  .tray-label { font-family:'Fredoka One',cursive;color:#f97316;font-size:0.95rem;text-align:center;margin-bottom:10px; }
  #pieceTray { display:flex;flex-wrap:wrap;gap:8px;justify-content:center;align-items:center;min-height:70px; }

  .puzzle-piece { cursor:grab;border-radius:6px;box-shadow:0 3px 10px rgba(0,0,0,0.18);touch-action:none;border:2px solid rgba(255,255,255,0.7);position:relative;overflow:hidden;flex-shrink:0; }
  .puzzle-piece:active { box-shadow:0 8px 20px rgba(0,0,0,0.28);cursor:grabbing; }
  .puzzle-piece.placed { cursor:default; }
  .puzzle-piece img { display:block;pointer-events:none; }
  .correct-flash { position:absolute;inset:0;background:rgba(34,197,94,0.4);border-radius:10px;animation:flashGreen 0.4s ease forwards;pointer-events:none; }
  @keyframes flashGreen { 0%{opacity:1} 100%{opacity:0} }

  .win-overlay { display:none;position:fixed;inset:0;z-index:200;background:rgba(240,253,250,0.94);backdrop-filter:blur(10px);flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:30px; }
  .win-overlay.show { display:flex; }
  .win-big { font-size:5rem;animation:spinBounce 1s ease infinite alternate; }
  @keyframes spinBounce { from{transform:rotate(-10deg)scale(1)} to{transform:rotate(10deg)scale(1.14)} }
  .win-overlay h2 { font-family:'Fredoka One',cursive;font-size:clamp(2rem,6vw,3rem);color:#0284c7;margin:14px 0 8px; }
  .win-overlay p { font-size:1.05rem;color:#0369a1;font-weight:700;margin:4px 0; }
  .win-image { width:150px;height:150px;object-fit:cover;border-radius:var(--radius);border:4px solid #fbbf24;box-shadow:0 8px 24px rgba(0,0,0,0.14);margin:12px 0; }
  .win-btn { margin-top:12px;background:linear-gradient(135deg,#06b6d4,#0284c7);color:white;border:none;border-radius:50px;padding:12px 32px;font-family:'Fredoka One',cursive;font-size:1.05rem;cursor:pointer;box-shadow:0 6px 18px rgba(6,182,212,0.40); }
  .confetti { position:absolute;font-size:1.5rem;animation:cfFall linear forwards;pointer-events:none; }
  @keyframes cfFall { from{transform:translateY(-50px)rotate(0deg);opacity:1} to{transform:translateY(110vh)rotate(720deg);opacity:0} }
</style>
</head>
<body>
<div class="cloud" style="top:7%;animation-duration:28s;animation-delay:0s;">‚òÅÔ∏è</div>
<div class="cloud" style="top:20%;animation-duration:38s;animation-delay:10s;font-size:2rem;">‚òÅÔ∏è</div>

<div class="win-overlay" id="winOverlay">
  <div style="position:absolute;inset:0;pointer-events:none;overflow:hidden;" id="cfContainer"></div>
  <div class="win-big">üéâ</div>
  <h2>Puzzle Complete!</h2>
  <img id="winImg" class="win-image" src="" alt="">
  <p id="winMoves"></p><p id="winTime"></p><p id="winMsg"></p>
  <button class="win-btn" onclick="restartGame()">üß© Play Again!</button>
  <a href="index.html" style="margin-top:10px;display:inline-block;color:#0284c7;font-weight:900;font-size:1rem;text-decoration:none;">üè† Home</a>
</div>

<header>
  <a href="index.html" class="home-btn">üè† Home</a>
  <h1>üß© Jigsaw Magic!</h1>
  <div class="hsp"></div>
</header>

<div class="upload-area">
  <span class="up-label">üì∏ Upload a photo to puzzle-ify!</span>
  <div class="upload-row">
    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">üìÅ Upload Photo</button>
    <span style="color:#94a3b8;font-weight:700;font-size:0.85rem;">or pick an emoji picture:</span>
  </div>
  <input type="file" id="fileInput" accept="image/*">
  <div class="up-status" id="upStatus"></div>
  <div class="default-picks" id="defaultPicks"></div>
</div>

<div class="controls-bar">
  <button class="diff-btn active" onclick="setDiff(2,2,this)">Easy (4 pcs)</button>
  <button class="diff-btn" onclick="setDiff(3,3,this)">Medium (9)</button>
  <button class="diff-btn" onclick="setDiff(4,4,this)">Hard (16)</button>
  <button class="start-btn" id="startBtn" onclick="startGame()">üöÄ Start!</button>
</div>

<div class="stats-row">
  <div class="stat">üî¢ Moves: <span id="moveCount">0</span></div>
  <div class="stat">‚è±Ô∏è <span id="timerDisp">0:00</span></div>
  <div class="stat">‚úÖ <span id="placedCount">0</span>/<span id="totalCount">0</span></div>
</div>

<div class="game-wrapper">
  <div style="display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap;justify-content:center;width:100%;">
    <div class="preview-box" id="previewBox">
      <div class="preview-label">üñºÔ∏è Goal</div>
      <img id="previewImg" class="preview-img" src="" alt="">
    </div>
    <div style="flex:1;min-width:220px;max-width:440px;">
      <div class="puzzle-section">
        <div class="puzzle-label">üß© Drop pieces here!</div>
        <div id="puzzleBoard"></div>
      </div>
    </div>
  </div>
  <div class="tray-section">
    <div class="tray-label">üëá Drag pieces from here!</div>
    <div id="pieceTray"></div>
  </div>
</div>

<script>
const DEFAULT_IMAGES=[{emoji:'üåà',colors:['#FF6B6B','#FFD93D','#6BCB77','#4D96FF','#C77DFF']},{emoji:'ü¶Ñ',colors:['#FFB3C6','#FF85A1','#FFCAD4','#F9C6FF','#E8B4FF']},{emoji:'üå∏',colors:['#FFB7C5','#FF8FAB','#FFC8DD','#FFAFCC','#CDB4DB']},{emoji:'üê¨',colors:['#90E0EF','#00B4D8','#ADE8F4','#48CAE4','#0096C7']},{emoji:'ü¶Å',colors:['#FFDDA1','#FFB347','#FFD97D','#FFA552','#FF8C00']}];
let cols=2,rows=2,currentImageSrc=null,moves=0,placed=0;
let timerInterval=null,seconds=0,boardW=280,boardH=280,pieceW,pieceH,selectedDefault=0;

// default picks
const picksContainer=document.getElementById('defaultPicks');
DEFAULT_IMAGES.forEach((img,i)=>{
  const btn=document.createElement('div');
  btn.className='default-pick'+(i===0?' selected':'');
  btn.textContent=img.emoji;
  btn.onclick=()=>{document.querySelectorAll('.default-pick').forEach(b=>b.classList.remove('selected'));btn.classList.add('selected');selectedDefault=i;currentImageSrc=null;document.getElementById('upStatus').textContent='';};
  picksContainer.appendChild(btn);
});

// FILE UPLOAD ‚Äî wait for FileReader fully before enabling start
document.getElementById('fileInput').addEventListener('change',function(e){
  const file=e.target.files[0];
  if(!file)return;
  document.getElementById('startBtn').disabled=true;
  document.getElementById('upStatus').textContent='‚è≥ Loading image‚Ä¶';
  const reader=new FileReader();
  reader.onload=ev=>{
    currentImageSrc=ev.target.result;
    document.querySelectorAll('.default-pick').forEach(b=>b.classList.remove('selected'));
    document.getElementById('upStatus').textContent='‚úÖ Photo ready!';
    document.getElementById('startBtn').disabled=false;
  };
  reader.onerror=()=>{document.getElementById('upStatus').textContent='‚ùå Could not load image';document.getElementById('startBtn').disabled=false;};
  reader.readAsDataURL(file);
});

function setDiff(c,r,btn){cols=c;rows=r;document.querySelectorAll('.diff-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');}

function startTimer(){clearInterval(timerInterval);seconds=0;timerInterval=setInterval(()=>{seconds++;const m=Math.floor(seconds/60),s=seconds%60;document.getElementById('timerDisp').textContent=`${m}:${s.toString().padStart(2,'0')}`;},1000);}

function buildEmojiImage(def,w,h){return new Promise(resolve=>{const c=document.createElement('canvas');c.width=w;c.height=h;const ctx=c.getContext('2d');const sw=w/def.colors.length;def.colors.forEach((col,i)=>{ctx.fillStyle=col;ctx.fillRect(i*sw,0,sw+1,h);});ctx.font=`${Math.min(w,h)*0.52}px serif`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(def.emoji,w/2,h/2);resolve(c.toDataURL());});}

async function startGame(){
  moves=0;placed=0;
  document.getElementById('moveCount').textContent='0';
  document.getElementById('timerDisp').textContent='0:00';
  document.getElementById('placedCount').textContent='0';
  const maxW=Math.min(window.innerWidth-80,400);
  boardW=maxW;boardH=maxW;pieceW=boardW/cols;pieceH=boardH/rows;
  document.getElementById('totalCount').textContent=cols*rows;

  let imgSrc=currentImageSrc;
  if(!imgSrc)imgSrc=await buildEmojiImage(DEFAULT_IMAGES[selectedDefault],boardW,boardH);

  const previewBox=document.getElementById('previewBox');
  const previewImg=document.getElementById('previewImg');
  previewImg.src=imgSrc;
  previewBox.style.display='flex';

  const board=document.getElementById('puzzleBoard');
  board.innerHTML='';
  board.style.width=boardW+'px';
  board.style.height=boardH+'px';

  for(let r=0;r<rows;r++)for(let c=0;c<cols;c++){
    const slot=document.createElement('div');
    slot.style.cssText=`position:absolute;left:${c*pieceW}px;top:${r*pieceH}px;width:${pieceW}px;height:${pieceH}px;border:2px dashed rgba(6,182,212,0.30);border-radius:4px;`;
    slot.dataset.slot=`${r}-${c}`;
    board.appendChild(slot);
  }

  document.getElementById('pieceTray').innerHTML='';

  // slice image into pieces
  const img=new Image();
  img.onload=()=>{
    const pieces=[];
    for(let r=0;r<rows;r++)for(let c=0;c<cols;c++){
      const canvas=document.createElement('canvas');
      canvas.width=pieceW;canvas.height=pieceH;
      canvas.getContext('2d').drawImage(img,c*(img.width/cols),r*(img.height/rows),img.width/cols,img.height/rows,0,0,pieceW,pieceH);
      pieces.push({row:r,col:c,dataUrl:canvas.toDataURL(),id:`${r}-${c}`});
    }
    for(let i=pieces.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pieces[i],pieces[j]]=[pieces[j],pieces[i]];}
    const tray=document.getElementById('pieceTray');
    pieces.forEach(pd=>{
      const el=document.createElement('div');
      el.className='puzzle-piece';el.dataset.id=pd.id;
      el.style.width=pieceW+'px';el.style.height=pieceH+'px';
      const pImg=document.createElement('img');pImg.src=pd.dataUrl;
      pImg.style.cssText=`width:${pieceW}px;height:${pieceH}px;border-radius:4px;`;
      el.appendChild(pImg);setupDrag(el);tray.appendChild(el);
    });
    startTimer();
  };
  img.src=imgSrc;
}

let dragEl=null,dragOffX=0,dragOffY=0,dragClone=null;
function setupDrag(el){
  el.addEventListener('touchstart',e=>{e.preventDefault();const t=e.touches[0];startDrag(el,t.clientX,t.clientY);document.addEventListener('touchmove',onTM,{passive:false});document.addEventListener('touchend',onTE);},{passive:false});
  el.addEventListener('mousedown',e=>{startDrag(el,e.clientX,e.clientY);document.addEventListener('mousemove',onMM);document.addEventListener('mouseup',onMU);});
}
function onTM(e){e.preventDefault();moveDrag(e.touches[0].clientX,e.touches[0].clientY);}
function onTE(e){endDrag(e.changedTouches[0].clientX,e.changedTouches[0].clientY);document.removeEventListener('touchmove',onTM);document.removeEventListener('touchend',onTE);}
function onMM(e){moveDrag(e.clientX,e.clientY);}
function onMU(e){endDrag(e.clientX,e.clientY);document.removeEventListener('mousemove',onMM);document.removeEventListener('mouseup',onMU);}

function startDrag(el,cx,cy){
  if(el.classList.contains('placed'))return;
  dragEl=el;const r=el.getBoundingClientRect();dragOffX=cx-r.left;dragOffY=cy-r.top;
  dragClone=el.cloneNode(true);
  dragClone.style.cssText+=`position:fixed;z-index:9999;opacity:0.88;pointer-events:none;transform:scale(1.1) rotate(3deg);box-shadow:0 12px 32px rgba(0,0,0,0.28);transition:none;border-radius:8px;left:${cx-dragOffX}px;top:${cy-dragOffY}px;`;
  document.body.appendChild(dragClone);el.style.opacity='0.25';
}
function moveDrag(cx,cy){if(!dragClone)return;dragClone.style.left=(cx-dragOffX)+'px';dragClone.style.top=(cy-dragOffY)+'px';}
function endDrag(cx,cy){
  if(!dragEl||!dragClone)return;
  dragClone.remove();dragClone=null;dragEl.style.opacity='1';
  const board=document.getElementById('puzzleBoard');
  const br=board.getBoundingClientRect();
  const relX=cx-br.left,relY=cy-br.top;
  if(relX>=0&&relX<=boardW&&relY>=0&&relY<=boardH){
    const tc=Math.floor(relX/pieceW),tr=Math.floor(relY/pieceH);
    if(tc>=0&&tc<cols&&tr>=0&&tr<rows){
      const[cr,cc]=dragEl.dataset.id.split('-').map(Number);
      moves++;document.getElementById('moveCount').textContent=moves;
      if(tr===cr&&tc===cc){
        const slot=board.querySelector(`[data-slot="${cr}-${cc}"]`);
        if(slot&&!slot.querySelector('.placed-piece')){
          const pp=dragEl.cloneNode(true);
          pp.className='puzzle-piece placed';
          pp.style.cssText=`position:absolute;left:${cc*pieceW}px;top:${cr*pieceH}px;width:${pieceW}px;height:${pieceH}px;border:none;box-shadow:none;border-radius:4px;z-index:5;cursor:default;`;
          pp.classList.add('placed-piece');board.appendChild(pp);
          const flash=document.createElement('div');flash.className='correct-flash';
          flash.style.cssText=`position:absolute;left:${cc*pieceW}px;top:${cr*pieceH}px;width:${pieceW}px;height:${pieceH}px;z-index:6;`;
          board.appendChild(flash);setTimeout(()=>flash.remove(),400);
          dragEl.remove();placed++;document.getElementById('placedCount').textContent=placed;
          if(placed===cols*rows){clearInterval(timerInterval);setTimeout(showWin,500);}
        }
      }else{dragEl.style.transform='translateX(-8px)';setTimeout(()=>{dragEl.style.transform='translateX(6px)';setTimeout(()=>{dragEl.style.transform='';},100);},100);}
    }
  }
  dragEl=null;
}

function showWin(){
  document.getElementById('winImg').src=document.getElementById('previewImg').src;
  const m=Math.floor(seconds/60),s=seconds%60;
  document.getElementById('winMoves').textContent=`Solved in ${moves} moves! üéØ`;
  document.getElementById('winTime').textContent=`Time: ${m}:${s.toString().padStart(2,'0')} ‚è±Ô∏è`;
  document.getElementById('winMsg').textContent=moves<cols*rows*2?'üåü Incredible! Puzzle Master!':moves<cols*rows*4?'üéâ Amazing job!':'üí™ Well done!';
  const cf=document.getElementById('cfContainer');cf.innerHTML='';
  'üéâüß©üåü‚ú®üéäüíñü¶ãüåàüéÄ‚≠ê'.split('').forEach(e=>{
    const el=document.createElement('div');el.className='confetti';el.textContent=e;
    el.style.left=Math.random()*100+'%';el.style.animationDuration=(2.5+Math.random()*2.5)+'s';el.style.animationDelay=(Math.random()*2)+'s';
    cf.appendChild(el);
  });
  document.getElementById('winOverlay').classList.add('show');
}
function restartGame(){document.getElementById('winOverlay').classList.remove('show');startGame();}
window.addEventListener('load',startGame);
</script>
</body>
</html>
