<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>üé® Magic Paint</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@700;900&family=Nunito:wght@700;900&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{width:100%;height:100%;overflow:hidden;font-family:"Nunito",sans-serif;background:#0f0520;}
.app{width:100%;height:100%;display:flex;flex-direction:column;}

/* HEADER */
header{flex-shrink:0;background:linear-gradient(90deg,#ec4899,#a855f7);padding:clamp(6px,1.2vw,10px) clamp(10px,2vw,16px);display:flex;align-items:center;gap:8px;box-shadow:0 3px 14px rgba(236,72,153,.5);}
.home-btn{background:rgba(255,255,255,.22);color:white;border:2px solid rgba(255,255,255,.5);border-radius:50px;padding:5px 12px;font-weight:900;font-size:.8rem;text-decoration:none;flex-shrink:0;}
.app-title{font-family:"Baloo 2",cursive;font-size:clamp(.95rem,3vw,1.5rem);color:white;flex:1;text-align:center;text-shadow:2px 2px 0 rgba(0,0,0,.2);}
.hdr-acts{display:flex;gap:6px;flex-shrink:0;}
.act-btn{background:rgba(255,255,255,.18);border:2px solid rgba(255,255,255,.4);border-radius:50px;padding:5px 11px;color:white;font-size:clamp(.68rem,1.8vw,.8rem);font-weight:900;cursor:pointer;white-space:nowrap;}
.act-btn:active{background:rgba(255,255,255,.38);}

/* CANVAS */
.canvas-area{flex:1;position:relative;overflow:hidden;background:white;touch-action:none;}
#bgCanvas,#paintCanvas{position:absolute;inset:0;width:100%;height:100%;}
#bgCanvas{pointer-events:none;}
#paintCanvas{cursor:crosshair;touch-action:none;}
.sticker-layer{position:absolute;inset:0;pointer-events:none;z-index:5;}
.sticker-el{position:absolute;pointer-events:all;cursor:pointer;animation:sDrop .3s ease;font-size:2rem;}
@keyframes sDrop{from{transform:scale(0)rotate(-20deg);opacity:0}to{transform:scale(1)rotate(0);opacity:1}}
.sticker-el:active{transform:scale(1.4)!important;}

/* TOOLBAR */
.toolbar{flex-shrink:0;background:linear-gradient(180deg,#1e1b4b,#0f0520);padding:clamp(6px,1.2vw,10px) clamp(8px,1.5vw,12px);display:flex;flex-direction:column;gap:clamp(5px,1vw,8px);}

/* TABS */
.t-tabs{display:flex;gap:5px;justify-content:center;}
.t-tab{background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.2);border-radius:50px;padding:clamp(4px,.8vw,6px) clamp(9px,1.8vw,14px);color:rgba(255,255,255,.65);font-size:clamp(.65rem,1.7vw,.8rem);font-weight:900;cursor:pointer;transition:all .2s;}
.t-tab.active{background:linear-gradient(135deg,#ec4899,#a855f7);color:white;border-color:transparent;box-shadow:0 3px 10px rgba(236,72,153,.5);}

/* PANEL: COLOURS */
.palette{display:flex;gap:clamp(5px,1.1vw,8px);flex-wrap:wrap;justify-content:center;align-items:center;}
.c-dot{width:clamp(24px,5vw,34px);height:clamp(24px,5vw,34px);border-radius:50%;cursor:pointer;border:2.5px solid rgba(255,255,255,.3);transition:transform .15s,border-color .15s;flex-shrink:0;}
.c-dot.active,.c-dot:active{transform:scale(1.32);border-color:white;box-shadow:0 0 0 3px rgba(255,255,255,.45);}

/* PANEL: BRUSH */
.brush-panel{display:none;flex-direction:column;gap:6px;}
.row-lbl{color:rgba(255,255,255,.45);font-size:clamp(.6rem,1.5vw,.7rem);font-weight:900;text-align:center;letter-spacing:1.5px;text-transform:uppercase;}
.brush-sizes{display:flex;gap:8px;align-items:center;justify-content:center;}
.sz-btn{border-radius:50%;background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.22);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;}
.sz-btn.active,.sz-btn:active{border-color:white;background:rgba(255,255,255,.3);}
.brush-types{display:flex;gap:6px;justify-content:center;flex-wrap:wrap;}
.bt-btn{background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.2);border-radius:50px;padding:5px 12px;color:rgba(255,255,255,.7);font-size:clamp(.65rem,1.7vw,.78rem);font-weight:900;cursor:pointer;transition:all .18s;}
.bt-btn.active{background:linear-gradient(135deg,#ec4899,#a855f7);color:white;border-color:transparent;}

/* PANEL: STICKERS */
.sticker-panel{display:none;}
.sticker-grid{display:flex;gap:clamp(5px,1vw,8px);flex-wrap:wrap;justify-content:center;max-height:clamp(55px,8vw,75px);overflow-y:auto;}
.s-pick{font-size:clamp(1.3rem,4vw,1.9rem);cursor:pointer;padding:3px;border-radius:8px;background:rgba(255,255,255,.07);border:2px solid transparent;transition:all .15s;}
.s-pick:active,.s-pick.active{transform:scale(1.38);background:rgba(255,255,255,.2);border-color:rgba(255,255,255,.5);}

/* PANEL: MAGIC */
.magic-panel{display:none;}
.magic-row{display:flex;gap:6px;justify-content:center;flex-wrap:wrap;}
.m-btn{background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.2);border-radius:50px;padding:5px 12px;color:rgba(255,255,255,.7);font-size:clamp(.65rem,1.7vw,.78rem);font-weight:900;cursor:pointer;transition:all .18s;}
.m-btn.active{background:linear-gradient(135deg,#eab308,#f97316);color:white;border-color:transparent;}

/* UPLOAD MODAL */
.modal{display:none;position:fixed;inset:0;z-index:50;background:rgba(0,0,0,.65);backdrop-filter:blur(8px);align-items:center;justify-content:center;padding:16px;}
.modal.open{display:flex;}
.modal-card{background:white;border-radius:22px;padding:24px 20px;max-width:340px;width:100%;text-align:center;animation:mIn .3s ease;}
@keyframes mIn{from{transform:scale(.7);opacity:0}to{transform:scale(1);opacity:1}}
.modal-card h3{font-family:"Baloo 2",cursive;font-size:1.3rem;color:#7c3aed;margin-bottom:8px;}
.modal-card p{font-size:.85rem;font-weight:700;color:#6b7280;line-height:1.5;margin-bottom:14px;}
.modal-up{background:linear-gradient(135deg,#a855f7,#ec4899);color:white;border:none;border-radius:50px;padding:10px 24px;font-family:"Baloo 2",cursive;font-size:.95rem;cursor:pointer;display:block;width:100%;margin-bottom:8px;}
.modal-skip{background:none;border:2px solid #e5e7eb;border-radius:50px;padding:8px 20px;color:#6b7280;font-weight:700;cursor:pointer;font-size:.85rem;width:100%;}
</style>
</head>
<body>

<div class="modal" id="bgModal">
  <div class="modal-card">
    <h3>üñºÔ∏è Upload a Drawing!</h3>
    <p>Papa can upload one of Eshanvi's drawings or a colouring page outline, and she can paint it with brushes, colours, and stickers!</p>
    <button class="modal-up" onclick="document.getElementById('bgUpload').click()">üìÅ Choose Drawing / Photo</button>
    <input type="file" id="bgUpload" accept="image/*" style="display:none">
    <button class="modal-skip" onclick="closeModal()">Start with blank white canvas</button>
  </div>
</div>

<div class="app">
  <header>
    <a href="index.html" class="home-btn">üè† Home</a>
    <div class="app-title">üé® Magic Paint Studio</div>
    <div class="hdr-acts">
      <div class="act-btn" onclick="openModal()">üñºÔ∏è Upload</div>
      <div class="act-btn" onclick="undoLast()">‚Ü©Ô∏è Undo</div>
      <div class="act-btn" onclick="clearAll()">üóëÔ∏è Clear</div>
      <div class="act-btn" onclick="saveImg()">üíæ Save</div>
    </div>
  </header>

  <div class="canvas-area" id="canvasArea">
    <canvas id="bgCanvas"></canvas>
    <canvas id="paintCanvas"></canvas>
    <div class="sticker-layer" id="stickerLayer"></div>
  </div>

  <div class="toolbar">
    <div class="t-tabs">
      <div class="t-tab active" id="tabC" onclick="switchTab('C')">üé® Colours</div>
      <div class="t-tab"        id="tabB" onclick="switchTab('B')">üñåÔ∏è Brush</div>
      <div class="t-tab"        id="tabS" onclick="switchTab('S')">‚≠ê Stickers</div>
      <div class="t-tab"        id="tabM" onclick="switchTab('M')">‚ú® Magic</div>
    </div>

    <!-- COLOURS -->
    <div class="palette" id="palette"></div>

    <!-- BRUSH -->
    <div class="brush-panel" id="panelB">
      <div class="row-lbl">Brush Size</div>
      <div class="brush-sizes" id="sizesRow"></div>
      <div class="row-lbl" style="margin-top:4px">Brush Type</div>
      <div class="brush-types" id="typesRow"></div>
    </div>

    <!-- STICKERS -->
    <div class="sticker-panel" id="panelS">
      <div class="sticker-grid" id="stickerGrid"></div>
    </div>

    <!-- MAGIC -->
    <div class="magic-panel" id="panelM">
      <div class="magic-row" id="magicRow"></div>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ CANVAS ‚îÄ‚îÄ
const paintCanvas=document.getElementById("paintCanvas");
const bgCanvas=document.getElementById("bgCanvas");
const ctx=paintCanvas.getContext("2d");
const bgCtx=bgCanvas.getContext("2d");
const area=document.getElementById("canvasArea");

let snapshots=[]; // for undo
function saveSnap(){snapshots.push(ctx.getImageData(0,0,paintCanvas.width,paintCanvas.height));if(snapshots.length>20)snapshots.shift();}
function undoLast(){if(snapshots.length){ctx.putImageData(snapshots.pop(),0,0);}}

function resize(){
  const w=area.clientWidth,h=area.clientHeight;
  const snap=ctx.getImageData(0,0,paintCanvas.width,paintCanvas.height);
  paintCanvas.width=bgCanvas.width=w;
  paintCanvas.height=bgCanvas.height=h;
  try{ctx.putImageData(snap,0,0);}catch(e){}
  drawBg();
}

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let drawing=false,lx=0,ly=0;
let color="#ec4899",brushSize=16,brushType="round",magic="none",stickerMode=null;
let rainbowHue=0;

// ‚îÄ‚îÄ COLOURS ‚îÄ‚îÄ
const COLORS=["#ef4444","#f97316","#eab308","#22c55e","#06b6d4","#3b82f6","#8b5cf6","#ec4899",
              "#ffffff","#000000","#fbbf24","#34d399","#60a5fa","#c084fc","#f472b6",
              "#a3e635","#fca5a5","#fdba74","#7c3aed","#374151"];
const pal=document.getElementById("palette");
COLORS.forEach(c=>{
  const d=document.createElement("div");d.className="c-dot"+(c===color?" active":"");
  d.style.background=c;
  d.onclick=()=>{color=c;if(brushType==="eraser")brushType="round";updateBrushTypeUI();document.querySelectorAll(".c-dot").forEach(x=>x.classList.remove("active"));d.classList.add("active");stickerMode=null;};
  pal.appendChild(d);
});
// Rainbow picker
const cp=document.createElement("div");cp.className="c-dot";cp.style.background="conic-gradient(red,yellow,lime,cyan,blue,magenta,red)";cp.title="Custom";
cp.onclick=()=>{const i=document.createElement("input");i.type="color";i.value=color;i.oninput=e=>color=e.target.value;i.click();};
pal.appendChild(cp);

// ‚îÄ‚îÄ BRUSH SIZES ‚îÄ‚îÄ
const SIZES=[4,10,18,32,56];
const szRow=document.getElementById("sizesRow");
SIZES.forEach(s=>{
  const btn=document.createElement("div");btn.className="sz-btn"+(s===brushSize?" active":"");
  const vis=Math.max(14,Math.min(s*.7,26));
  btn.style.width=(vis+12)+"px";btn.style.height=(vis+12)+"px";
  btn.innerHTML="<div style='width:"+vis+"px;height:"+vis+"px;border-radius:50%;background:white;opacity:.8'></div>";
  btn.onclick=()=>{brushSize=s;document.querySelectorAll(".sz-btn").forEach(x=>x.classList.remove("active"));btn.classList.add("active");};
  szRow.appendChild(btn);
});

// ‚îÄ‚îÄ BRUSH TYPES ‚îÄ‚îÄ
const BRUSH_TYPES=[{id:"round",lbl:"‚úèÔ∏è Pen"},{id:"spray",lbl:"üí¶ Spray"},{id:"chalk",lbl:"üñçÔ∏è Chalk"},{id:"felt",lbl:"üñäÔ∏è Felt"},{id:"eraser",lbl:"üßπ Erase"}];
const typeRow=document.getElementById("typesRow");
BRUSH_TYPES.forEach(bt=>{
  const btn=document.createElement("div");btn.className="bt-btn"+(bt.id===brushType?" active":"");
  btn.textContent=bt.lbl;
  btn.onclick=()=>{brushType=bt.id;document.querySelectorAll(".bt-btn").forEach(x=>x.classList.remove("active"));btn.classList.add("active");};
  typeRow.appendChild(btn);
});
function updateBrushTypeUI(){document.querySelectorAll(".bt-btn").forEach((b,i)=>{b.classList.toggle("active",BRUSH_TYPES[i].id===brushType);});}

// ‚îÄ‚îÄ STICKERS ‚îÄ‚îÄ
const STICKERS=["‚≠ê","üåü","‚ú®","üí´","üå∏","üå∫","üåà","ü¶ã","‚ù§Ô∏è","üíñ","üíï","üéÄ","üéâ","üéä","ü•≥","üéà","ü¶Ñ","üê±","üê∂","üê∏","ü¶ä","üêº","üê∞","üê•","üç≠","üç¨","üç¶","üßÅ","üç©","üåô","‚òÄÔ∏è","üåª","üçÄ","üå¥","üéµ","üå†","üèÖ","ü¶Å","üêò","üåä","üçÄ","üå∑"];
const sg=document.getElementById("stickerGrid");
STICKERS.forEach(s=>{
  const sp=document.createElement("div");sp.className="s-pick";sp.textContent=s;
  sp.onclick=()=>{document.querySelectorAll(".s-pick").forEach(x=>x.classList.remove("active"));sp.classList.add("active");stickerMode=s;};
  sg.appendChild(sp);
});

// ‚îÄ‚îÄ MAGIC EFFECTS ‚îÄ‚îÄ
const MAGIC=[{id:"none",lbl:"‚úèÔ∏è Normal"},{id:"rainbow",lbl:"üåà Rainbow"},{id:"glow",lbl:"‚ú® Glow"},{id:"stars",lbl:"‚≠ê Starfall"},{id:"sparkle",lbl:"üíé Sparkle"},{id:"bubble",lbl:"ü´ß Bubbles"}];
const mr=document.getElementById("magicRow");
MAGIC.forEach(m=>{
  const btn=document.createElement("div");btn.className="m-btn"+(m.id===magic?" active":"");
  btn.textContent=m.lbl;
  btn.onclick=()=>{magic=m.id;document.querySelectorAll(".m-btn").forEach(x=>x.classList.remove("active"));btn.classList.add("active");stickerMode=null;};
  mr.appendChild(btn);
});

// ‚îÄ‚îÄ TAB SWITCHING ‚îÄ‚îÄ
function switchTab(t){
  document.getElementById("palette").style.display=t==="C"?"flex":"none";
  document.getElementById("panelB").style.display=t==="B"?"flex":"none";
  document.getElementById("panelS").style.display=t==="S"?"block":"none";
  document.getElementById("panelM").style.display=t==="M"?"block":"none";
  ["C","B","S","M"].forEach(id=>document.getElementById("tab"+id).classList.toggle("active",id===t));
  if(t!=="S")stickerMode=null;
}

// ‚îÄ‚îÄ DRAW ‚îÄ‚îÄ
function getXY(e){
  const r=paintCanvas.getBoundingClientRect();
  const sx=paintCanvas.width/r.width,sy=paintCanvas.height/r.height;
  if(e.touches&&e.touches.length) return {x:(e.touches[0].clientX-r.left)*sx,y:(e.touches[0].clientY-r.top)*sy};
  return {x:(e.clientX-r.left)*sx,y:(e.clientY-r.top)*sy};
}

function getDrawColor(){return magic==="rainbow"?(rainbowHue=(rainbowHue+4)%360,"hsl("+rainbowHue+",100%,55%)"):color;}

function doDraw(x,y){
  if(!drawing)return;
  const c=getDrawColor();
  ctx.lineCap="round";ctx.lineJoin="round";

  if(brushType==="eraser"){
    ctx.globalCompositeOperation="destination-out";
    ctx.strokeStyle="rgba(0,0,0,1)";ctx.lineWidth=brushSize*1.8;
    ctx.beginPath();ctx.moveTo(lx,ly);ctx.lineTo(x,y);ctx.stroke();
    ctx.globalCompositeOperation="source-over";
  } else if(brushType==="spray"){
    const d=brushSize*2.5;
    for(let i=0;i<d;i++){
      const a=Math.random()*Math.PI*2,r=Math.random()*brushSize;
      ctx.fillStyle=c;ctx.globalAlpha=Math.random()*.5+.1;
      ctx.fillRect(x+Math.cos(a)*r,y+Math.sin(a)*r,1.5,1.5);
    }
    ctx.globalAlpha=1;
  } else if(brushType==="chalk"){
    ctx.globalAlpha=.3;ctx.strokeStyle=c;ctx.lineWidth=brushSize;
    for(let i=0;i<5;i++){
      ctx.beginPath();ctx.moveTo(lx+Math.random()*5-2.5,ly+Math.random()*5-2.5);
      ctx.lineTo(x+Math.random()*5-2.5,y+Math.random()*5-2.5);ctx.stroke();
    }
    ctx.globalAlpha=1;
  } else if(brushType==="felt"){
    ctx.globalAlpha=.55;ctx.strokeStyle=c;ctx.lineWidth=brushSize*1.2;
    ctx.beginPath();ctx.moveTo(lx,ly);ctx.lineTo(x,y);ctx.stroke();
    ctx.globalAlpha=1;
  } else {
    if(magic==="glow"){ctx.shadowBlur=22;ctx.shadowColor=c;}
    ctx.strokeStyle=c;ctx.lineWidth=brushSize;
    ctx.beginPath();ctx.moveTo(lx,ly);ctx.lineTo(x,y);ctx.stroke();
    ctx.shadowBlur=0;
  }

  // Extra magic particles
  if(magic==="stars"&&Math.random()<.35){ctx.font=(6+Math.random()*10)+"px serif";ctx.globalAlpha=.8;ctx.fillText("‚≠ê",x+Math.random()*28-14,y+Math.random()*28-14);ctx.globalAlpha=1;}
  if(magic==="sparkle"&&Math.random()<.3){["‚ú¶","‚úß","‚ú∂"].forEach(sp=>{if(Math.random()<.3){ctx.font=(6+Math.random()*8)+"px serif";ctx.fillStyle=c;ctx.globalAlpha=.7;ctx.fillText(sp,x+Math.random()*24-12,y+Math.random()*24-12);ctx.globalAlpha=1;}});}
  if(magic==="bubble"&&Math.random()<.28){const r=brushSize*.5+Math.random()*6;ctx.beginPath();ctx.arc(x+Math.random()*20-10,y+Math.random()*20-10,r,0,Math.PI*2);ctx.strokeStyle=c;ctx.lineWidth=2;ctx.globalAlpha=.5;ctx.stroke();ctx.globalAlpha=1;}

  lx=x;ly=y;
}

// Mouse
paintCanvas.addEventListener("mousedown",e=>{if(stickerMode){placeSticker(e);return;}saveSnap();drawing=true;const p=getXY(e);lx=p.x;ly=p.y;doDraw(p.x,p.y);});
paintCanvas.addEventListener("mousemove",e=>{if(!drawing)return;const p=getXY(e);doDraw(p.x,p.y);});
paintCanvas.addEventListener("mouseup",()=>drawing=false);
paintCanvas.addEventListener("mouseleave",()=>drawing=false);
// Touch
paintCanvas.addEventListener("touchstart",e=>{e.preventDefault();if(stickerMode){placeSticker(e);return;}saveSnap();drawing=true;const p=getXY(e);lx=p.x;ly=p.y;doDraw(p.x,p.y);},{passive:false});
paintCanvas.addEventListener("touchmove",e=>{e.preventDefault();if(!drawing)return;const p=getXY(e);doDraw(p.x,p.y);},{passive:false});
paintCanvas.addEventListener("touchend",()=>drawing=false,{passive:false});

// ‚îÄ‚îÄ STICKER PLACE ‚îÄ‚îÄ
function placeSticker(e){
  const r=area.getBoundingClientRect();
  let cx,cy;
  if(e.touches&&e.touches.length){cx=e.touches[0].clientX-r.left;cy=e.touches[0].clientY-r.top;}
  else{cx=e.clientX-r.left;cy=e.clientY-r.top;}
  const el=document.createElement("div");el.className="sticker-el";el.textContent=stickerMode;
  const sz=Math.max(20,Math.min(brushSize*1.6,56));
  el.style.cssText="left:"+(cx-sz/2)+"px;top:"+(cy-sz/2)+"px;font-size:"+sz+"px;";
  el.addEventListener("click",()=>el.remove());
  document.getElementById("stickerLayer").appendChild(el);
}

// ‚îÄ‚îÄ BG / UPLOAD ‚îÄ‚îÄ
let bgImage=null;
function drawBg(){
  bgCtx.fillStyle="white";bgCtx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
  if(bgImage){
    const sc=Math.min(bgCanvas.width/bgImage.width,bgCanvas.height/bgImage.height);
    const w=bgImage.width*sc,h=bgImage.height*sc;
    bgCtx.globalAlpha=.92;bgCtx.drawImage(bgImage,(bgCanvas.width-w)/2,(bgCanvas.height-h)/2,w,h);bgCtx.globalAlpha=1;
  }
}
function openModal(){document.getElementById("bgModal").classList.add("open");}
function closeModal(){document.getElementById("bgModal").classList.remove("open");}
document.getElementById("bgUpload").addEventListener("change",function(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{const img=new Image();img.onload=()=>{bgImage=img;drawBg();};img.src=ev.target.result;};
  reader.readAsDataURL(file);
  closeModal();
});

// ‚îÄ‚îÄ CLEAR / SAVE ‚îÄ‚îÄ
function clearAll(){
  ctx.clearRect(0,0,paintCanvas.width,paintCanvas.height);
  document.getElementById("stickerLayer").innerHTML="";
  snapshots=[];drawBg();
}
function saveImg(){
  const sv=document.createElement("canvas");sv.width=paintCanvas.width;sv.height=paintCanvas.height;
  const sc=sv.getContext("2d");
  sc.drawImage(bgCanvas,0,0);sc.drawImage(paintCanvas,0,0);
  document.querySelectorAll(".sticker-el").forEach(s=>{
    const x=parseFloat(s.style.left)+parseFloat(s.style.fontSize)/2;
    const y=parseFloat(s.style.top)+parseFloat(s.style.fontSize);
    sc.font=s.style.fontSize+" serif";sc.fillText(s.textContent,x,y);
  });
  const a=document.createElement("a");a.download="eshanvi-art-"+Date.now()+".png";a.href=sv.toDataURL();a.click();
}

window.addEventListener("resize",resize);
window.addEventListener("load",()=>{resize();openModal();});
</script>
</body>
</html>
